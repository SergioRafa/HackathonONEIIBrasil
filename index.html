<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight On Time - Predi√ß√£o Inteligente</title>
    <link rel="stylesheet" href="./styles/style.css">
</head>
<body>
    <main class="apresentacao">
        <section class="apresentacao__conteudo">
            <h1 class="apresentacao__conteudo__titulo">Flight <strong class="titulo-destaque">On Time</strong></h1>
            <p class="apresentacao__conteudo__texto">
                An√°lise preditiva de atrasos em tempo real.<br>
                Informe os dados do voo para processamento via IA:
            </p>
            
            <form class="pesquisar" id="meuFormulario">
                <div class="input-group">
                    <div class="field-container">
                        <label for="origem">Origem (IATA):</label>
                        <input type="text" id="origem" placeholder="Ex: GIG" maxlength="3" oninput="this.value = this.value.toUpperCase()" required>
                    </div>
                    <div class="field-container">
                        <label for="destino">Destino (IATA):</label>
                        <input type="text" id="destino" placeholder="Ex: JFK" maxlength="3" oninput="this.value = this.value.toUpperCase()" required>
                    </div>
                </div>

                <div class="input-group">
                    <div class="field-container">
                        <label for="distanciaKm">Dist√¢ncia (km):</label>
                        <input type="number" id="distanciaKm" placeholder="Ex: 7700" required>
                    </div>
                    <div class="field-container">
                        <label for="dataPartida">Data do Voo:</label>
                        <input type="date" id="dataPartida" required>
                    </div>
                </div>

                <div class="apresentacao__links">
                    <button type="button" id="btn-analisar" class="apresentacao__links__navegacao" onclick="enviarDados(event)" style="width: 100%; border: none; cursor: pointer;">
                        EXECUTAR AN√ÅLISE PREDITIVA
                    </button>
                </div>
            </form>

            <div id="resultado" class="resultado-container" style="display: none;">
                <div id="mensagem-retorno"></div>
            </div>
        </section>
        <img class="apresentacao__imagem" src="assets/aviao.png" alt="Foto de aeronave">
    </main>

    <script>
        // Trava o calend√°rio para n√£o aceitar datas passadas ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date().toISOString().split("T")[0];
            document.getElementById('dataPartida').setAttribute('min', hoje);
        });

        async function enviarDados(event) {
            event.preventDefault();

            const origem = document.getElementById('origem').value;
            const destino = document.getElementById('destino').value;
            const distancia = document.getElementById('distanciaKm').value;
            const data = document.getElementById('dataPartida').value;
            const btn = document.getElementById('btn-analisar');

            if (!origem || !destino || !distancia || !data) {
                alert("Por favor, preencha todos os campos.");
                return;
            }

            const containerResultado = document.getElementById('resultado');
            const mensagemRetorno = document.getElementById('mensagem-retorno');

            // 1. Estado de carregamento e bloqueio do bot√£o
            btn.disabled = true;
            btn.innerText = "PROCESSANDO...";
            containerResultado.style.display = 'block';
            containerResultado.className = 'resultado-container'; 
            mensagemRetorno.innerHTML = `<div class="loading-text">üõ∞Ô∏è Consultando StormGlass e IA...</div>`;

            const dadosVoo = {
                companhia: "Latam",
                origem: origem.toUpperCase(),
                destino: destino.toUpperCase(),
                dataPartida: data + "T12:00:00", // Mant√©m o padr√£o ISO esperado pelo Spring
                distanciaKm: parseInt(distancia)
            };

            try {
                // URL DO SEU NGROK
                const response = await fetch('https://uncompulsive-shelly-nonclerically.ngrok-free.dev/api/previsao/predict', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true' // Pula a tela de aviso do ngrok para requisi√ß√µes fetch
                    },
                    body: JSON.stringify(dadosVoo)
                });

                if (!response.ok) throw new Error("Erro na resposta do servidor");

                const resultado = await response.json();
                
                // Normaliza a probabilidade (converte 0.78 para 78 ou mant√©m 78 se j√° vier assim)
                const probRaw = resultado.probabilidade;
                const prob = Math.round(probRaw <= 1 ? probRaw * 100 : probRaw);
                
                let classe, icone, texto;
                if (prob <= 15) {
                    classe = 'resultado-sucesso'; icone = '‚úÖ'; texto = 'V√îO PONTUAL';
                } else if (prob <= 40) {
                    classe = 'resultado-alerta'; icone = '‚ö†Ô∏è'; texto = 'RISCO MODERADO';
                } else {
                    classe = 'resultado-perigo'; icone = 'üö®'; texto = 'ALTO RISCO DE ATRASO';
                }

                // 2. Atualizar a interface
                containerResultado.className = `resultado-container ${classe}`;
                mensagemRetorno.innerHTML = `
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">${icone} ${texto}</div>
                    <div style="font-size: 2.5rem; font-weight: 800;">${prob}%</div>
                    <p style="font-size: 0.9rem; color: #333;">Probabilidade de atraso calculada via ML</p>
                    <div style="border-top: 1px solid rgba(0,0,0,0.1); margin-top: 10px; padding-top: 10px; font-size: 0.8rem;">
                        üì° Server Status: Online | üïí ${new Date().toLocaleTimeString()}
                    </div>
                `;

            } catch (error) {
                console.error("Erro:", error);
                containerResultado.className = 'resultado-container resultado-perigo';
                mensagemRetorno.innerHTML = "‚ùå Erro de conex√£o. Certifique-se que o ngrok e o IntelliJ est√£o ativos.";
            } finally {
                // Reativa o bot√£o
                btn.disabled = false;
                btn.innerText = "EXECUTAR AN√ÅLISE PREDITIVA";
            }
        }
    </script>
</body>
</html>